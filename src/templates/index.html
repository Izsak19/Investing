<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trading Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #0f172a;
        color: #e2e8f0;
      }
      header {
        padding: 1rem 1.5rem;
        background: #1e293b;
        border-bottom: 1px solid #334155;
      }
      main {
        padding: 1.5rem;
      }
      #chart {
        width: 100%;
        height: 480px;
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .metric {
        padding: 0.75rem 1rem;
        background: #1f2937;
        border: 1px solid #334155;
        border-radius: 8px;
      }
      .metric h3 {
        margin: 0 0 0.5rem;
        font-size: 0.95rem;
        color: #a5b4fc;
      }
      .metric span {
        font-size: 1.2rem;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Live Trading View</h1>
      <p>Latest candles, actions, and portfolio metrics streamed from the trainer.</p>
      <p id="status" style="margin: 0; font-size: 0.9rem; color: #94a3b8;">
        Connecting to trainer…
      </p>
    </header>
    <main>
      <div id="chart"></div>
      <section class="metrics">
        <div class="metric">
          <h3>Portfolio Value</h3>
          <span id="portfolioValue">--</span>
        </div>
        <div class="metric">
          <h3>Cash</h3>
          <span id="cashValue">--</span>
        </div>
        <div class="metric">
          <h3>Position</h3>
          <span id="positionValue">--</span>
        </div>
        <div class="metric">
          <h3>Success Rate</h3>
          <span id="successRate">--</span>
        </div>
        <div class="metric">
          <h3>Total Reward</h3>
          <span id="totalReward">--</span>
        </div>
        <div class="metric">
          <h3>Trainer Reward (Step)</h3>
          <span id="trainerReward">--</span>
        </div>
        <div class="metric">
          <h3>Portfolio Δ (MTM)</h3>
          <span id="mtmDelta">--</span>
        </div>
        <div class="metric">
          <h3>Trade Impact</h3>
          <span id="tradeImpact">--</span>
        </div>
        <div class="metric">
          <h3>Fee Paid</h3>
          <span id="feePaid">--</span>
        </div>
        <div class="metric">
          <h3>Turnover Penalty</h3>
          <span id="turnoverPenalty">--</span>
        </div>
        <div class="metric">
          <h3>Refilled</h3>
          <span id="refilled">--</span>
        </div>
        <div class="metric">
          <h3>Refill Count</h3>
          <span id="refillCount">--</span>
        </div>
        <div class="metric">
          <h3>Executed Trades</h3>
          <span id="executedTrades">--</span>
        </div>
        <div class="metric">
          <h3>Sell Win Rate</h3>
          <span id="sellWinRate">--</span>
        </div>
      </section>
    </main>
    <script>
      const candleTrace = {
        x: [],
        open: [],
        high: [],
        low: [],
        close: [],
        type: "candlestick",
        name: "Price",
        increasing: { line: { color: "#10b981" } },
        decreasing: { line: { color: "#ef4444" } },
      };

      const actionTrace = {
        x: [],
        y: [],
        mode: "markers",
        name: "Actions",
        marker: { size: 10, color: [] },
        text: [],
        hovertemplate: "%{text}<br>Price: %{y}<extra></extra>",
      };

      const portfolioTrace = {
        x: [],
        y: [],
        mode: "lines",
        name: "Portfolio Value",
        line: { color: "#fbbf24" },
        yaxis: "y2",
      };

      let lastId = -1;
      let latestMetrics = null;
      const POLL_INTERVAL_MS = 1000;
      const statusEl = document.getElementById("status");

      function updateMetrics(metrics) {
        if (!metrics) return;
        document.getElementById("portfolioValue").textContent = (metrics.portfolio_value || 0).toFixed(2);
        document.getElementById("cashValue").textContent = (metrics.cash || 0).toFixed(2);
        document.getElementById("positionValue").textContent = (metrics.position || 0).toFixed(6);
        document.getElementById("successRate").textContent = `${(metrics.success_rate || 0).toFixed(2)}%`;
        document.getElementById("totalReward").textContent = (metrics.total_reward || 0).toFixed(2);
        document.getElementById("trainerReward").textContent = (metrics.trainer_reward || 0).toFixed(4);
        document.getElementById("mtmDelta").textContent = (metrics.mtm_delta || 0).toFixed(4);
        document.getElementById("tradeImpact").textContent = (metrics.trade_impact || 0).toFixed(4);
        document.getElementById("feePaid").textContent = (metrics.fee_paid || 0).toFixed(4);
        document.getElementById("turnoverPenalty").textContent = (metrics.turnover_penalty || 0).toFixed(4);
        document.getElementById("refilled").textContent = metrics.refilled ? "Yes" : "No";
        document.getElementById("refillCount").textContent = metrics.refill_count ?? 0;
        document.getElementById("executedTrades").textContent = metrics.executed_trades ?? 0;
        document.getElementById("sellWinRate").textContent = `${((metrics.sell_win_rate || 0) * 100).toFixed(2)}%`;
      }

      function updateChart(events) {
        if (!events || events.length === 0) return;

        const candleUpdate = {
          x: [[]],
          open: [[]],
          high: [[]],
          low: [[]],
          close: [[]],
        };

        const actionUpdate = {
          x: [[]],
          y: [[]],
          text: [[]],
          "marker.color": [[]],
        };

        const portfolioUpdate = {
          x: [[]],
          y: [[]],
        };

        events.forEach((evt) => {
          const label = evt.timestamp || `Step ${evt.step}`;

          candleUpdate.x[0].push(label);
          candleUpdate.open[0].push(evt.open);
          candleUpdate.high[0].push(evt.high);
          candleUpdate.low[0].push(evt.low);
          candleUpdate.close[0].push(evt.close);

          const actionColor = evt.action === "buy" ? "#22c55e" : evt.action === "sell" ? "#ef4444" : "#6366f1";
          actionUpdate.x[0].push(label);
          actionUpdate.y[0].push(evt.close);
          actionUpdate.text[0].push(`${evt.action.toUpperCase()} @ ${evt.close.toFixed(2)}`);
          actionUpdate["marker.color"][0].push(actionColor);

          portfolioUpdate.x[0].push(label);
          portfolioUpdate.y[0].push(evt.portfolio_value);
        });

        Plotly.extendTraces("chart", candleUpdate, [0], history);
        Plotly.extendTraces("chart", actionUpdate, [1], history);
        Plotly.extendTraces("chart", portfolioUpdate, [2], history);
      }

      function mergeMetrics(payload) {
        const hasMetrics = payload.metrics && Object.keys(payload.metrics).length > 0;
        const latestEvent = payload.events && payload.events.length > 0 ? payload.events[payload.events.length - 1] : null;
        const merged = { ...(latestMetrics || {}) };

        if (hasMetrics) {
          Object.assign(merged, payload.metrics);
        }

        if (latestEvent) {
          merged.portfolio_value ??= latestEvent.portfolio_value;
          merged.cash ??= latestEvent.cash;
          merged.position ??= latestEvent.position;
          merged.trainer_reward ??= latestEvent.trainer_reward;
          merged.mtm_delta ??= latestEvent.mtm_delta;
          merged.trade_impact ??= latestEvent.trade_impact;
          merged.fee_paid ??= latestEvent.fee_paid;
          merged.turnover_penalty ??= latestEvent.turnover_penalty;
          merged.refilled ??= latestEvent.refilled;
          merged.refill_count ??= latestEvent.refill_count;
          merged.executed_trades ??= latestEvent.executed_trades;
          merged.sell_win_rate ??= latestEvent.sell_win_rate;
          merged.success_rate ??= latestEvent.success_rate;
          merged.total_reward ??= latestEvent.total_reward;
        }

        latestMetrics = merged;
        return merged;
      }

      async function pollOnce() {
        try {
          const res = await fetch(`/api/events?since=${lastId}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          lastId = payload.last_id ?? lastId;
          updateChart(payload.events);
          const mergedMetrics = mergeMetrics(payload);
          updateMetrics(mergedMetrics);
          statusEl.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        } catch (err) {
          console.error("Poll failed", err);
          statusEl.textContent = "Disconnected from trainer";
        }
      }

      async function startPolling() {
        while (true) {
          await pollOnce();
          await new Promise((resolve) => setTimeout(resolve, POLL_INTERVAL_MS));
        }
      }

      const history = 500;

      Plotly.newPlot("chart", [candleTrace, actionTrace, portfolioTrace], {
        template: "plotly_dark",
        margin: { t: 40, r: 20, b: 40, l: 60 },
        xaxis: { rangeslider: { visible: false } },
        yaxis: { title: "Price" },
        yaxis2: {
          title: "Portfolio",
          overlaying: "y",
          side: "right",
          showgrid: false,
        },
        legend: { orientation: "h" },
      });

      startPolling();
    </script>
  </body>
</html>
